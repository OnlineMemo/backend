commands:
  create_heapdump_dir:
    command: |
      mkdir -p /var/log/heapdump
      chown webapp:webapp /var/log/heapdump
      chmod 750 /var/log/heapdump
      usermod -a -G webapp ec2-user || true

files:
  "/etc/cron.hourly/heapdump-cleanup":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      cd /var/log/heapdump 2>/dev/null || exit 0
      chown webapp:webapp *.hprof 2>/dev/null
      HEAPDUMP_COUNT=$(ls -1 *.hprof 2>/dev/null | wc -l)
      if [ $HEAPDUMP_COUNT -gt 1 ]; then
        ls -t *.hprof | tail -n +2 | xargs rm -f
      fi